# Spell System Architecture

**Last Updated:** 2025-12-13  
**Status:** Active Development  
**Architecture Version:** V2 (Component-Based)  

## Executive Summary

The Aralia RPG spell system implements a robust, data-driven architecture that moves away from fragile regex-based parsing toward explicit, component-based JSON definitions. This enables complex spell mechanics, reliable execution, and extensible design.

## System Overview

### Core Principles

1. **Single Source of Truth (SSOT):** Spell JSON files are the authoritative data source
2. **Explicit Over Implicit:** Effects are defined structurally, not inferred from text
3. **Type Safety:** Strict TypeScript interfaces ensure data integrity
4. **Component-Based:** Spells are containers for reusable effect components
5. **Extensible Design:** New mechanics can be added without system rewrites

### Architecture Layers

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Presentation Layer                       â”‚
â”‚  Spellbook UI, Combat View, Glossary Display               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    Business Logic Layer                     â”‚
â”‚  SpellService, useSpellGateChecks, spellAbilityFactory     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    Data Access Layer                        â”‚
â”‚  JSON Schema Validation, Manifest Loading, Caching         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    Data Layer                               â”‚
â”‚  public/data/spells/**/*.json, spells_manifest.json        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Data Model

### Spell Structure

The `Spell` interface (defined in `src/types/spells.ts`) consists of:

#### Metadata
- `id`: Unique kebab-case identifier
- `name`: Display name
- `level`: Spell level (0-9)
- `school`: Magic school classification
- `classes`: Array of classes/subclasses that can cast this spell
- `tags`: Categorization keywords
- `description`: Flavor text
- `higherLevels`: Higher-level casting description

#### Mechanics
- `ritual`: Can be cast as ritual
- `castingTime`: Time required to cast
- `range`: Spell range specification
- `components`: Required material/verbal/somatic components
- `duration`: How long the spell lasts

#### Execution
- `targeting`: Who/what can be targeted
- `effects`: Array of structured effect components
- `engineHook`: Implementation status tracking

### Effect Components

Spells contain one or more effect components that define what happens when cast:

#### DamageEffect
```typescript
{
  type: 'DAMAGE',
  damage: { dice: '8d6', type: 'Fire' },
  trigger: { type: 'immediate' },
  condition: { type: 'hit', saveType: 'Dexterity' }
}
```

#### HealingEffect
```typescript
{
  type: 'HEALING',
  healing: { dice: '2d8+5', type: 'temp_hp' },
  trigger: { type: 'immediate' },
  condition: { type: 'always' }
}
```

#### StatusConditionEffect
```typescript
{
  type: 'STATUS_CONDITION',
  statusCondition: { name: 'Invisible', duration: { type: 'minutes', value: 1 } },
  trigger: { type: 'immediate' },
  condition: { type: 'save', saveType: 'Wisdom' }
}
```

#### MovementEffect
```typescript
{
  type: 'MOVEMENT',
  movementType: 'teleport',
  distance: 30,
  trigger: { type: 'immediate' },
  condition: { type: 'always' }
}
```

#### Other Effect Types
- `SummoningEffect`: Creates summoned creatures
- `TerrainEffect`: Modifies battlefield terrain
- `UtilityEffect`: Various non-combat utilities
- `DefensiveEffect`: Grants defensive bonuses

## System Components

### 1. Data Management

#### Spell JSON Files
- **Location:** `public/data/spells/level-{N}/{spell-id}.json`
- **Structure:** Nested by spell level for organization
- **Validation:** Zod schema in `src/systems/spells/validation/spellValidator.ts`

#### Manifest System
- **File:** `public/data/spells_manifest.json`
- **Purpose:** Index of all available spells with metadata
- **Generated by:** `scripts/generate-spell-manifest.ts`

#### Schema Validation
- **JSON Schema:** `src/systems/spells/schema/spell.schema.json`
- **Zod Validator:** Runtime validation with detailed error reporting
- **Validation Command:** `npm run validate:spells`

### 2. Service Layer

#### SpellService
**File:** `src/services/SpellService.ts`  
**Responsibilities:**
- Loading spell data from JSON files
- Providing spell lookup by ID
- Managing spell manifest access
- Caching frequently accessed spells

#### SpellContext
**File:** `src/context/SpellContext.tsx`  
**Responsibilities:**
- Global spell state management
- Providing spell data to React components
- Handling loading/error states

### 3. Business Logic

#### spellAbilityFactory
**File:** `src/utils/spellAbilityFactory.ts`  
**Responsibilities:**
- Converting spell JSON to executable abilities
- Handling both V2 (structured) and legacy (text-parsed) formats
- Creating combat-ready ability objects

#### useSpellGateChecks
**File:** `src/hooks/useSpellGateChecks.ts`  
**Responsibilities:**
- Validating spell data integrity
- Checking for implementation gaps
- Providing spell readiness status

### 4. Presentation Layer

#### SpellbookOverlay
**File:** `src/components/CharacterSheet/Spellbook/SpellbookOverlay.tsx`  
**Responsibilities:**
- Displaying known spells
- Managing prepared spells
- Handling spell casting interface

#### Combat Spell Integration
**Files:** `src/components/Combat/`, `src/hooks/useAbilitySystem.ts`  
**Responsibilities:**
- Rendering spell targeting UI
- Executing spell effects in combat
- Managing spell slot consumption

## Integration Points

### Character Creation
**Files:** `src/components/CharacterCreator/`  
**Integration:**
- Filtering spells by class availability
- Populating initial spellbook during character creation
- Validating spell selections

### Glossary System
**Files:** `src/components/Glossary/`  
**Integration:**
- Displaying spell descriptions
- Providing search functionality
- Cross-referencing related spells/terms

### Combat Engine
**Files:** `src/hooks/useAbilitySystem.ts`, `src/components/Combat/`  
**Integration:**
- Executing spell effects
- Handling targeting and range validation
- Managing concentration and duration tracking

## Current Implementation Status

### Completed âœ…
- [x] V2 JSON schema definition
- [x] Zod validation system
- [x] Spell manifest generation
- [x] Basic spell loading service
- [x] Character sheet spellbook integration
- [x] Combat spell casting (basic effects)

### In Progress ğŸš§
- [~] Complete spell migration (375 total, ~23% migrated)
- [~] Advanced targeting system (AoE shapes)
- [~] Multi-effect spell support
- [~] Concentration management

### Planned ğŸ”®
- [ ] Geometric grid algorithms for precise AoE
- [ ] Advanced spell interactions (counterspells, dispelling)
- [ ] Spell scroll crafting system
- [ ] Magical item spell integration

## Migration Path

### From Legacy to V2

#### Legacy Format Characteristics
- Flat JSON structure
- Minimal structured data
- Heavy reliance on regex parsing of description text
- Limited effect representation

#### V2 Format Characteristics
- Nested by spell level
- Rich structured effects array
- Explicit targeting definitions
- Complete mechanical representation

#### Migration Process
1. **Audit existing spells** using `docs/spells/STATUS_LEVEL_{N}.md`
2. **Convert to V2 schema** using templates from `docs/spells/SPELL_JSON_EXAMPLES.md`
3. **Validate conversion** with `npm run validate:spells`
4. **Test integration** in character creation and combat
5. **Update status tracking** files

## Performance Considerations

### Optimization Strategies

#### Data Loading
- Manifest-based indexing for fast lookups
- Lazy loading of spell details
- Client-side caching of frequently used spells

#### Runtime Execution
- Pre-compiled effect handlers
- Batch processing of simultaneous effects
- Efficient targeting calculations

#### Memory Management
- Cleanup of unused spell data
- Smart caching with eviction policies
- Bundle splitting for spell data

## Testing Strategy

### Unit Testing
- **Spell validation:** `src/systems/spells/validation/__tests__/`
- **Effect execution:** `src/systems/spells/effects/__tests__/`
- **Type safety:** `src/types/__tests__/spells.test-d.ts`

### Integration Testing
- **Character creation flow:** Spell selection and validation
- **Combat scenarios:** Spell casting and effect application
- **Data integrity:** Manifest consistency and JSON validation

### Manual Testing
- **Spell functionality:** In-game casting and effects
- **Edge cases:** Unusual targeting scenarios
- **Performance:** Large-scale spell usage

## Troubleshooting Guide

### Common Issues

#### Validation Failures
**Symptom:** `npm run validate` reports schema errors  
**Solution:** Check required fields, enum values, and effect structure against `docs/spells/SPELL_JSON_EXAMPLES.md`

#### Spell Not Appearing
**Symptom:** Spell missing from character sheet or combat  
**Solution:** Verify spell exists in manifest, class lists include the spell, and ID spelling is consistent

#### Effect Not Working
**Symptom:** Spell casts but produces no visible effect  
**Solution:** Check effect type implementation in `useAbilitySystem.ts`, verify trigger/condition logic

### Debugging Tools
- **Spell Gate Checker:** `src/hooks/useSpellGateChecks.ts`
- **Validation Scripts:** `scripts/validate-data.ts`
- **Console Logging:** Built-in spell execution logging

## Future Enhancements

### Short Term (Next 3 Months)
- Complete migration of remaining spells to V2 format
- Implement advanced AoE targeting algorithms
- Add spell scroll crafting mechanics

### Medium Term (3-6 Months)
- Develop spell research/minor creation system
- Implement magical item spell integration
- Add spell customization options

### Long Term (6+ Months)
- Create spell school specialization mechanics
- Develop spell metamagic system
- Implement spell domain interactions

## Contributing

### Getting Started
1. Read `docs/guides/SPELL_ADDITION_WORKFLOW_GUIDE.md`
2. Review `docs/spells/SPELL_JSON_EXAMPLES.md` for format examples
3. Check `docs/spells/STATUS_LEVEL_{N}.md` for migration priorities

### Development Workflow
1. Create/modify spell JSON files
2. Run validation: `npm run validate:spells`
3. Test in development environment
4. Submit pull request with validation results

### Code Standards
- Follow existing TypeScript interface patterns
- Maintain consistent JSON structure
- Include comprehensive validation
- Document complex effect logic

---

**Related Documentation:**
- [SPELL_ADDITION_WORKFLOW_GUIDE.md](../guides/SPELL_ADDITION_WORKFLOW_GUIDE.md) - How to add spells
- [SPELL_JSON_EXAMPLES.md](../spells/SPELL_JSON_EXAMPLES.md) - Format reference
- [SPELL_INTEGRATION_CHECKLIST.md](../spells/SPELL_INTEGRATION_CHECKLIST.md) - Integration testing
- [@SPELL-SYSTEM-OVERHAUL-TODO.md](../tasks/spell-system-overhaul/@SPELL-SYSTEM-OVERHAUL-TODO.md) - Implementation roadmap